name: download
run-name: ${{ inputs.M3U8_TITLE }} GitHub Actions M3U8 Download
on:
  workflow_dispatch:
    inputs:
      M3U8_URL:
        description: 'M3U8_URL'
        required: true
      M3U8_TITLE:
        description: 'è§†é¢‘åç§°'
        default: 'video'
        required: true
jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä¸»åˆ†æ”¯
        uses: actions/checkout@main

      - name: åˆå§‹åŒ–ä¸‹è½½ç¯å¢ƒ
        id: tool
        run: |
          unzip wget.zip
          ./wget.exe --no-check-certificate -O cmd.zip ${{ secrets.M3U8TOOLS }}
          unzip cmd.zip
          del *G.exe
          ren N*.exe cmd.exe

      - name: å¼€å§‹ä¸‹è½½è§†é¢‘èµ„æº
        id: download
        if: (!cancelled())
        run: ./cmd.exe "${{ github.event.inputs.M3U8_URL }}" --saveName "${{ github.event.inputs.M3U8_TITLE }}" --enableDelAfterDone
          
      - name: ç¼“å­˜å…¨éƒ¨æ–‡ä»¶
        uses: actions/upload-artifact@main
        if: (!cancelled())
        with:
          name: Downloads
          path: Downloads

  deploy:
    needs: build
    runs-on: ubuntu-20.04
    steps:
    - name: æ£€å‡ºä¸»åˆ†æ”¯
      uses: actions/checkout@main

    - name: è°ƒå–ç¼“å­˜å…¨éƒ¨æ–‡ä»¶
      uses: actions/download-artifact@main
      with:
        name: Downloads
        path: Downloads
      
    - name: å‘å¸ƒè§†é¢‘åˆ°WeTransfer
      id: wetransfer
      if: (!cancelled())
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress Downloads 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
        echo "å½±ç‰‡åç§°ï¼šã€Š${{ github.event.inputs.M3U8_TITLE }}ã€‹" >> body.md
        echo "" >> body.md
        echo "ğŸ”— [WeTransfer]($(cat wetransfer.log | grep https | cut -f3 -d" "))" >> body.md

    - name: ç”Ÿæˆç‰ˆæœ¬å·
      id: tag
      if: (!cancelled())
      run: echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT

    - name: å‘å¸ƒè§†é¢‘åˆ°release
      uses: softprops/action-gh-release@v1
      if: (!cancelled())
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: body.md

    - name: ç§»é™¤è€çš„ workflow runs
      uses: zhoujinshi/delete-workflow-runs@main
      if: (!cancelled())
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: ç§»é™¤è€çš„ Releases
      uses: dev-drprasad/delete-older-releases@master
      if: (!cancelled())
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
